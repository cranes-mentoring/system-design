### –£—Ä–æ–∫: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ –≤ PostgreSQL

#### –í–≤–µ–¥–µ–Ω–∏–µ –≤ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ PostgreSQL –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –≤ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å—Ä–µ–¥–µ, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∏ –∏–∑–±–µ–≥–∞—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞–±–æ—Ç–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

1. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫ (ROW LEVEL LOCKS)**:
    - **FOR UPDATE**: –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–æ—Ä–∫—É –¥—Ä—É–≥–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `FOR UPDATE`.
    - **FOR NO KEY UPDATE**: –ü–æ—Ö–æ–∂–µ –Ω–∞ `FOR UPDATE`, –Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä—É–≥–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –∏–∑–º–µ–Ω—è—Ç—å –Ω–µ–∫–ª—é—á–µ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã.
    - **FOR SHARE**: –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–∞–∑—Ä–µ—à–∞—è –¥—Ä—É–≥–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –∏—Ö –≤—ã–±–æ—Ä–∫—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `FOR SHARE`.
    - **FOR KEY SHARE**: –°–∞–º–∞—è —Å–ª–∞–±–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –∫–ª—é—á–µ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã.

2. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã (TABLE LEVEL LOCKS)**:
    - **ACCESS SHARE**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è.
    - **ROW SHARE**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ.
    - **ROW EXCLUSIVE**: –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–π –∂–µ –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É.
    - **SHARE UPDATE EXCLUSIVE**: –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —á—Ç–µ–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
    - **SHARE**: –ü–æ–∑–≤–æ–ª—è–µ—Ç —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å—Ç—Ä–æ–∫, –Ω–æ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã.
    - **SHARE ROW EXCLUSIVE**: –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è, —á–µ–º ROW EXCLUSIVE, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
    - **EXCLUSIVE**: –ë–ª–æ–∫–∏—Ä—É–µ—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
    - **ACCESS EXCLUSIVE**: –°–∞–º–∞—è —Å—Ç—Ä–æ–≥–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∞—è –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π.

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (ADVISORY LOCKS)**:
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

#### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫**:

  ```sql
  -- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  BEGIN;
  SELECT * FROM users WHERE id = 1 FOR UPDATE;
  UPDATE users SET name = '–ù–æ–≤–æ–µ –∏–º—è' WHERE id = 1;
  COMMIT;
  ```

- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã**:

  ```sql
  -- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
  BEGIN;
  LOCK TABLE users IN SHARE ROW EXCLUSIVE MODE;
  UPDATE users SET name = '–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∏–º—è' WHERE country = 'USA';
  COMMIT;
  ```

- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**:

  ```sql
  -- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–≤–µ—Ç—Å–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
  SELECT pg_advisory_lock(123456);
  -- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–π
  SELECT pg_advisory_unlock(123456);
  ```

### –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏

- –ò–∑–±–µ–≥–∞–π—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏, —á—Ç–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–∏–º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–∏–π —É—Ä–æ–≤–µ–Ω—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞—á–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∏–∑–ª–∏—à–Ω–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å –ø–æ–º–æ—â—å—é —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤ PostgreSQL, —Ç–∞–∫–∏—Ö –∫–∞–∫ `pg_stat_activity` –∏ `pg_locks`.
- –†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏—Ö –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ –∏ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤ PostgreSQL —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É—á–µ—Ç–∞ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–∏–ø—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏ –∏—Ö —É—Ä–æ–≤–Ω–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏.


#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ

–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ N –∑–∞–ø–∏—Å–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —à–µ–¥—É–ª–µ—Ä–∞ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `FOR UPDATE` –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∏—Ö —à–µ–¥—É–ª–µ—Ä–æ–º. –í–∞–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.


üê∏üê∏üê∏ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã üê∏üê∏üê∏
1lock
   https://habr.com/ru/companies/tensor/articles/488024/
   https://www.postgresql.org/docs/9.1/functions-admin.html
   https://www.postgresql.org/docs/current/sql-select.html
   https://habr.com/ru/companies/postgrespro/articles/463819/

2) –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤
   https://www.postgresql.org/docs/current/sql-explain.html
   https://habr.com/ru/articles/203320/